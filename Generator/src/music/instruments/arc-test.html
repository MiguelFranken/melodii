<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Arc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <input id="ip" type="text" value="http://192.168.0.101:8080" />
    <span id="indicator">Not connected.</span>
    <br>

    <div class="keyboard">
        <div id="c4" class="key">C4</div>
        <div id="d4" class="key">D4</div>
        <div id="e4" class="key">E4</div>
        <div id="f4" class="key">F4</div>
        <div id="g4" class="key">G4</div>
        <div id="a4" class="key">A4</div>
        <div id="b4" class="key">B4</div>
        <div id="c5" class="key">C5</div>
    </div>

    <style>
        body {
            overflow: hidden;
        }

        .keyboard {
            display: grid;
            grid-gap: 0.5em;
            grid-template-columns: repeat(auto-fill, 10em);
        }

        .key {
            width: 10em;
            height: 10em;
            background: linear-gradient(hsl(0, 60%, 60%), hsl(0, 0%, 75%) 50%);
            user-select: none;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
    <script>
        const ipInput = document.getElementById("ip");
        const indicator = document.getElementById("indicator");
        ipInput.addEventListener("input", function () {
            initSocket(this.value);
        });
        initSocket(ipInput.value);
        function initSocket(ip) {
            indicator.innerText = "Connecting...";
            socket = io(ip);
            socket.on('connect', () => indicator.innerText = "Connected.");
            socket.on('event', () => console.log("Received event."));
            socket.on('disconnect', () => indicator.innerText = "Disconnected.");
            socket.on('error', () => indicator.innerText = "An error occurred.");
            socket.on('connect_error', () => indicator.innerText = "An error occurred while connecting.");
            socket.on('connect_timeout', () => indicator.innerText = "The connection timed out.");
        }

        const OSC_MESSAGE = 3;

        function set(note, strength) {
            console.log(`Set ${note} to ${strength}.`);
            socket.emit(OSC_MESSAGE, {
                address: "/arc/set",
                args: [
                    { type: "s", value: note },
                    { type: "i", value: strength }
                ],
                info: {},
            });
        }

        const button_ids = ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5"]
        for (id of button_ids) {
            let my_id = id;
            const el = document.getElementById(id.toLowerCase());
            el.addEventListener("mousemove", (event) => {
                const height = relativeHeight(event.offsetY, event.target.offsetHeight);
                start(height);
            });
            el.addEventListener("touchmove", (event) => {
                const t = event.changedTouches[0];
                const offsetY = t.clientY - t.target.offsetTop;
                const height = relativeHeight(offsetY, t.target.offsetHeight);
                start(height);
            })
            function start(height) {
                const velocity = height;
                set(my_id, velocity);
            }

            el.addEventListener("mouseleave", () => {
                stop();
            });
            el.addEventListener("touchend", () => {
                stop();
            })
            function stop() {
                set(my_id, 0)
            }
        }

        function relativeHeight(offsetY, targetOffsetHeight) {
            const topZero = Math.min(1, Math.max(0, offsetY / targetOffsetHeight));
            const bottomZero = 1 - topZero;
            return bottomZero;
        }
    </script>
</body>

</html>