<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Box</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <button id="c4">C4</button>
    <button id="d4">D4</button>
    <button id="e4">E4</button>
    <button id="f4">F4</button>
    <button id="g4">G4</button>
    <button id="a4">A4</button>
    <button id="b4">B4</button>
    <button id="c5">C5</button>

    <style>
        button {
            width: 10em;
            height: 10em;
            background: linear-gradient(hsl(0, 60%, 60%), hsl(0, 0%, 75%) 50%);
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
    <script>
        const socket = io("http://localhost:8080");

        socket.on('connect', () => console.log("Connected to socket."));
        socket.on('event', () => console.log("Received event."));
        socket.on('disconnect', () => console.log("Socket disconnected."));

        const OSC_MESSAGE = 3;

        function trigger(note, velocity) {
            console.log(`Trigger ${note}.`);
            socket.emit(OSC_MESSAGE, {
                address: "/box/trigger",
                args: [
                    { type: "s", value: note },
                    { type: "i", value: velocity }
                ],
                info: {},
            });
        }

        function detune(note, cents) {
            console.log(`Detune ${note}.`);
            socket.emit(OSC_MESSAGE, {
                address: "/box/detune",
                args: [
                    { type: "s", value: note },
                    { type: "i", value: cents }
                ],
                info: {}
            });
        }

        function release(note) {
            console.log(`Release ${note}.`);
            socket.emit(OSC_MESSAGE, {
                address: "/box/release",
                args: [
                    { type: "s", value: note }
                ],
                info: {}
            });
        }

        const button_ids = ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5"]
        let x_start = null;
        for (id of button_ids) {
            let my_id = id;
            const el = document.getElementById(id.toLowerCase());
            el.addEventListener("mousedown", (event) => {
                const velocity = relativeHeight(event);
                x_start = event.clientX;
                trigger(my_id, velocity);
            });
            el.addEventListener("mousemove", (event) => {
                console.log("Mousemove")
                if (x_start) {
                    const x_diff = event.clientX - x_start;
                    const cents = x_diff * 10;
                    detune(my_id, cents);
                }
            });
            el.addEventListener("mouseup", () => {
                x_start = null;
                release(my_id);
            });
        }

        function relativeHeight(event) {
            const topZero = Math.min(1, Math.max(0, event.offsetY / event.target.offsetHeight));
            const bottomZero = 1 - topZero;
            return bottomZero;
        }
    </script>
</body>

</html>